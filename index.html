<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visor de Pases con Capas • Frames</title>
  <style>
    :root{ --bg:#0b0d10; --panel:#111418; --text:#e5e7eb; --muted:#9aa5b1; --line:#1f2937; --accent:#60a5fa; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .app{display:grid; grid-template-rows:auto 1fr; height:100%}
    header{display:flex; align-items:center; gap:.5rem; padding:.5rem .75rem; background:linear-gradient(180deg,#0f1317,#0b0d10); border-bottom:1px solid var(--line)}
    header h1{font-size:14px;margin:0;letter-spacing:.2px;opacity:.95} .sp{flex:1}
    .btn{appearance:none; border:1px solid var(--line); background:#12161c; color:var(--text); padding:.35rem .6rem; border-radius:.45rem; font-size:12px; cursor:pointer}
    select.btn{padding:.25rem .4rem}
    .main{display:grid; grid-template-columns:300px 1fr; height:calc(100vh - 50px)}
    .left{border-right:1px solid var(--line); background:var(--panel); overflow:auto}
    .layers{padding:.5rem; display:flex; flex-direction:column; gap:.5rem}
    .layer{display:grid; grid-template-columns:20px 1fr; gap:.5rem; align-items:center; background:#0f1317; padding:.35rem; border-radius:.4rem; transition:opacity .15s ease}
    .layer.off{opacity:.45} 
    .layer label{font-size:12px; cursor:pointer}
    .layer input[type=checkbox]{accent-color:var(--accent);}
    .range{display:flex; align-items:center; gap:.25rem}
    .range input[type=range]{flex:1}
    .range .val{font-size:11px;width:30px;text-align:right;color:var(--muted)}
    /* indicadores de checkbox visibles */
    .row{display:flex; gap:.35rem; align-items:center}
    .row input[type=checkbox]{width:18px; height:18px; accent-color: var(--accent); cursor:pointer}
    canvas{display:block; width:100%; height:100%; background:#0a0c0f}
    .hint{position:absolute; bottom:.5rem; left:.5rem; font-size:12px; color:#c7cbd1; background:rgba(0,0,0,.4); padding:.25rem .4rem; border-radius:.3rem}
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Visor de Pases</h1>
    <div class="sp"></div>
    <label class="btn">Frame<select id="frameSel" class="btn"></select></label>
    <button class="btn" id="btnFit">Ajustar</button>
    <button class="btn" id="btn100">100%</button>
    <button class="btn" id="btnBG">BG</button>
    <label class="btn" for="file">Subir</label>
    <input id="file" type="file" accept="image/*" multiple hidden>
  </header>
  <div class="main">
    <aside class="left">
      <div class="layers" id="layers"></div>
    </aside>
    <section class="right" style="position:relative">
      <canvas id="cv"></canvas>
      <div class="hint">Drag&Drop también sobre el canvas. Sliders = opacidad sobre High.</div>
    </section>
  </div>
</div>
<script>
(()=>{
  const fileInput=document.getElementById('file');
  const frameSel=document.getElementById('frameSel');
  const layersEl=document.getElementById('layers');
  const cv=document.getElementById('cv');
  const ctx=cv.getContext('2d');
  const btnFit=document.getElementById('btnFit');
  const btn100=document.getElementById('btn100');
  const btnBG=document.getElementById('btnBG');
  let frames=new Map(); let current=null; let zoom=1,panX=0,panY=0; let baseW=0,baseH=0; let bg=0;

  function isHigh(name){return name.toLowerCase()==='high';}
  function parseName(fname){
    const base=fname.replace(/\.[^.]+$/,'');
    const m=base.match(/^(\d+)[-_ ]([A-Za-z0-9_]+)$/);
    if(!m) return {frame:'0000', pass:base};
    return {frame:m[1], pass:m[2]};
  }

  async function handleFiles(files){
    for(const f of files){
      if(!f.type.startsWith('image/')) continue;
      const url=URL.createObjectURL(f); const img=new Image();
      await new Promise(r=>{img.onload=r; img.src=url;});
      const {frame,pass}=parseName(f.name);
      if(!frames.has(frame)) frames.set(frame,{base:null,layers:[]});
      const fr=frames.get(frame);
      const entry={name:pass,img,w:img.naturalWidth,h:img.naturalHeight,visible:true,opacity:isHigh(pass)?1:0};
      if(isHigh(pass)) fr.base=entry; else fr.layers.push(entry);
    }
    updateFrameSel();
    if(!current) setCurrent(frameSel.value);
  }

  function updateFrameSel(){
    frameSel.innerHTML='';
    const keys=[...frames.keys()].sort((a,b)=>a-b);
    keys.forEach(k=>{let o=document.createElement('option');o.value=k;o.textContent=k;frameSel.appendChild(o);});
  }

  function setCurrent(fid){ current=frames.get(fid); frameSel.value=fid; baseW=current.base?current.base.w:current.layers[0].w; baseH=current.base?current.base.h:current.layers[0].h; zoom=fitZoom(); center(); renderLayersUI(); draw(); }

  function renderLayersUI(){
    layersEl.innerHTML='';
    if(!current) return;
    // High se muestra fijo, sin slider
    if(current.base){
      const baseRow=document.createElement('div'); baseRow.className='layer';
      const label=document.createElement('label'); label.textContent=`${current.base.name} (Base)`;
      baseRow.appendChild(document.createElement('span'));
      baseRow.appendChild(label);
      layersEl.appendChild(baseRow);
    }
    current.layers.forEach(L=>{
      const row=document.createElement('div'); row.className='layer' + (L.visible ? '' : ' off');
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=L.visible; cb.addEventListener('change',()=>{L.visible=cb.checked; row.classList.toggle('off', !L.visible); draw();});
      const meta=document.createElement('div');
      const label=document.createElement('div'); label.textContent=L.name; label.style.fontSize='12px';
      const range=document.createElement('div'); range.className='range';
      const slider=document.createElement('input'); slider.type='range'; slider.min=0; slider.max=100; slider.value=Math.round((L.opacity??0)*100);
      const val=document.createElement('div'); val.className='val'; val.textContent=`${slider.value}%`;
      slider.addEventListener('input',()=>{L.opacity=slider.value/100; val.textContent=`${slider.value}%`; draw();});
      range.appendChild(slider); range.appendChild(val);
      meta.appendChild(label); meta.appendChild(range);
      row.appendChild(cb); row.appendChild(meta);
      layersEl.appendChild(row);
    });
  }

  function fitZoom(){return Math.min(cv.clientWidth/baseW,cv.clientHeight/baseH);} function center(){panX=(cv.clientWidth-baseW*zoom)/2; panY=(cv.clientHeight-baseH*zoom)/2;}

  function draw(){
    ctx.setTransform(1,0,0,1,0,0); bg?drawBG():ctx.clearRect(0,0,cv.width,cv.height);
    if(!current) return;
    ctx.setTransform(1,0,0,1,panX,panY); ctx.scale(zoom,zoom);
    if(current.base) ctx.drawImage(current.base.img,0,0);
    current.layers.forEach(L=>{ if(!L.visible||L.opacity<=0) return; ctx.globalAlpha=L.opacity; ctx.drawImage(L.img,0,0); ctx.globalAlpha=1; });
  }

  function drawBG(){const s=16;for(let y=0;y<cv.height;y+=s){for(let x=0;x<cv.width;x+=s){ctx.fillStyle=((x+y)/s)%2?'#0e1218':'#0b0f15';ctx.fillRect(x,y,s,s);}}}

  fileInput.addEventListener('change',e=>handleFiles(e.target.files));
  ['dragenter','dragover'].forEach(ev=>cv.addEventListener(ev,e=>e.preventDefault()));
  ['dragleave','drop'].forEach(ev=>cv.addEventListener(ev,e=>e.preventDefault()));
  cv.addEventListener('drop',e=>handleFiles(e.dataTransfer.files));
  frameSel.addEventListener('change',()=>setCurrent(frameSel.value));
  btnFit.addEventListener('click',()=>{zoom=fitZoom();center();draw();});
  btn100.addEventListener('click',()=>{zoom=1;center();draw();});
  btnBG.addEventListener('click',()=>{bg=!bg;draw();});

  let drag=false,lx=0,ly=0; cv.addEventListener('mousedown',e=>{drag=true;lx=e.clientX;ly=e.clientY;}); window.addEventListener('mouseup',()=>drag=false); window.addEventListener('mousemove',e=>{if(!drag)return;panX+=(e.clientX-lx);panY+=(e.clientY-ly);lx=e.clientX;ly=e.clientY;draw();});
  cv.addEventListener('wheel',e=>{if(!current)return;e.preventDefault();const mx=e.offsetX,my=e.offsetY;const prev=zoom;const d=Math.sign(e.deltaY)*-0.1;zoom=Math.max(0.05,Math.min(32,zoom*(1+d)));const wx=(mx-panX)/prev,wy=(my-panY)/prev;panX=mx-wx*zoom;panY=my-wy*zoom;draw();},{passive:false});
  new ResizeObserver(()=>{cv.width=cv.clientWidth*devicePixelRatio;cv.height=cv.clientHeight*devicePixelRatio;ctx.scale(devicePixelRatio,devicePixelRatio);draw();}).observe(cv);
})();
</script>
</body>
</html>
