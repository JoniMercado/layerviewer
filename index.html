<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visor de Pases • Render Frames</title>
  <meta name="description" content="Subí varias imágenes del mismo frame (normal, diffuse, depth, reflection, etc.) y alterná entre pases. Compatible con GitHub Pages.">
  <style>
    :root{
      --bg:#0b0d10; --panel:#111418; --text:#e5e7eb; --muted:#9aa5b1;
      --line:#1f2937; --accent:#60a5fa; --accent2:#34d399; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .app{display:grid; grid-template-rows:auto 1fr; height:100%}
    header{display:flex; align-items:center; gap:.5rem; padding:.5rem .75rem; background:linear-gradient(180deg,#0f1317, #0b0d10); border-bottom:1px solid var(--line)}
    header h1{font-size:14px; margin:0; letter-spacing:.2px; opacity:.95}
    .sp{flex:1}
    .btn{appearance:none; border:1px solid var(--line); background:#12161c; color:var(--text); padding:.45rem .7rem; border-radius:.55rem; font-size:12px; cursor:pointer}
    .btn:hover{border-color:#2b3646}
    .btn[aria-pressed="true"]{outline:2px solid var(--accent); outline-offset:1px}
    .muted{color:var(--muted)}

    .main{display:grid; grid-template-columns:260px 1fr; height:calc(100vh - 50px)}
    .left{border-right:1px solid var(--line); background:var(--panel); overflow:auto}
    .right{position:relative;}

    .drop{margin:.75rem; padding:1rem; border:1px dashed #2a3340; border-radius:.75rem; text-align:center; background:#0b0f14}
    .drop.drag{border-color:var(--accent)}
    .drop p{margin:.25rem 0}
    .small{font-size:12px; color:var(--muted)}

    .passes{padding:.5rem}
    .pass{display:flex; align-items:center; gap:.5rem; padding:.4rem .5rem; border-radius:.5rem; cursor:pointer; border:1px solid transparent}
    .pass:hover{background:#0e1319}
    .pass.active{background:#0e1620; border-color:#203040}
    .pass span{font-size:12px}
    .thumb{width:40px; height:28px; background:#0a0a0a; border:1px solid #222; border-radius:.35rem; flex:0 0 auto; overflow:hidden; display:grid; place-items:center}
    .thumb img{max-width:100%; max-height:100%; display:block}

    .toolbar{position:absolute; top:.5rem; left:.5rem; display:flex; gap:.4rem; z-index:10}
    .toolbar .btn{backdrop-filter: blur(6px); background:rgba(18,22,28,.75)}

    canvas{display:block; width:100%; height:100%; background:#0a0c0f}
    .hint{position:absolute; bottom:.5rem; left:.5rem; font-size:12px; color:#c7cbd1; opacity:.85; background:rgba(9,11,15,.7); padding:.35rem .5rem; border-radius:.4rem; border:1px solid #1a2230}

    .footer{position:absolute; top:.5rem; right:.5rem; font-size:12px; color:var(--muted); background:rgba(18,22,28,.7); padding:.35rem .5rem; border-radius:.4rem; border:1px solid #1a2230}
    code.k{background:#0f1720; border:1px solid #202b3a; padding:.05rem .3rem; border-radius:.35rem}

    @media (max-width: 900px){
      .main{grid-template-columns: 1fr}
      .left{position:absolute; inset:auto 0 0 0; height:40%; border-right:none; border-top:1px solid var(--line)}
      .right{height:60vh}
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Visor de Pases</h1>
    <div class="sp"></div>
    <button class="btn" id="btnFit">Ajustar</button>
    <button class="btn" id="btn100">100%</button>
    <button class="btn" id="btnBG">BG</button>
    <label class="btn" for="file">Subir imágenes</label>
    <input id="file" type="file" accept="image/*" multiple hidden>
  </header>

  <div class="main">
    <aside class="left">
      <div id="drop" class="drop">
        <p><strong>Soltá acá</strong> o usá el botón “Subir imágenes”.</p>
        <p class="small">Ideal: nombrá los archivos como <code>frame_diffuse.png</code>, <code>frame_normal.jpg</code>, etc. El sufijo será el nombre del pase.</p>
      </div>
      <div class="passes" id="passes"></div>
    </aside>

    <section class="right">
      <div class="toolbar">
        <div class="btn muted" id="infoDim">–</div>
        <div class="btn muted" id="infoZoom">–</div>
      </div>
      <canvas id="cv"></canvas>
      <div class="hint">Rueda para zoom, arrastrá para pan. Teclas: <code class="k">1..9</code> para cambiar pase.</div>
      <div class="footer" id="footer">Sin imágenes</div>
    </section>
  </div>
</div>

<script>
(()=>{
  const fileInput = document.getElementById('file');
  const drop = document.getElementById('drop');
  const list = document.getElementById('passes');
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const btnFit = document.getElementById('btnFit');
  const btn100 = document.getElementById('btn100');
  const btnBG = document.getElementById('btnBG');
  const infoDim = document.getElementById('infoDim');
  const infoZoom = document.getElementById('infoZoom');
  const footer = document.getElementById('footer');

  let passes = []; // {name, img, url, w, h}
  let active = 0;
  let zoom = 1, panX = 0, panY = 0;
  let bgToggle = 0; // 0 sólido, 1 damero

  function nameFromFile(f){
    const base = f.name.replace(/\.[^.]+$/, '');
    const m = base.match(/(.+?)[-_ ]([A-Za-z0-9]+)$/);
    return m ? m[2] : base; // usa sufijo como 'diffuse'
  }

  function setCanvasSize(){
    cv.width = cv.clientWidth * devicePixelRatio;
    cv.height = cv.clientHeight * devicePixelRatio;
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(devicePixelRatio, devicePixelRatio);
    draw();
  }

  window.addEventListener('resize', setCanvasSize);

  function setActive(i){
    if(passes.length===0) return;
    active = Math.max(0, Math.min(i, passes.length-1));
    [...list.querySelectorAll('.pass')].forEach((el,idx)=>{
      el.classList.toggle('active', idx===active);
    });
    footer.textContent = passes[active].name;
    zoom = fitZoom();
    center();
    draw();
  }

  function addPass(obj){
    const idx = passes.push(obj) - 1;
    const item = document.createElement('div');
    item.className = 'pass' + (idx===active?' active':'');
    const th = document.createElement('div'); th.className='thumb';
    const im = document.createElement('img'); im.src = obj.url; th.appendChild(im);
    const sp = document.createElement('span'); sp.textContent = obj.name;
    item.appendChild(th); item.appendChild(sp);
    item.addEventListener('click', ()=> setActive(idx));
    list.appendChild(item);
    footer.textContent = `${passes.length} pase(s)`;
  }

  async function handleFiles(files){
    const sorted = [...files].sort((a,b)=> a.name.localeCompare(b.name));
    for(const f of sorted){
      if(!f.type.startsWith('image/')) continue;
      const url = URL.createObjectURL(f);
      const img = new Image();
      await new Promise(res=>{ img.onload=res; img.src=url; });
      addPass({name:nameFromFile(f), img, url, w:img.naturalWidth, h:img.naturalHeight});
    }
    if(passes.length>0){
      setActive(passes.length-1); // última subida activa
      updateInfo();
    }
  }

  fileInput.addEventListener('change', e=> handleFiles(e.target.files));

  ;['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.add('drag');}));
  ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.remove('drag');}));
  drop.addEventListener('drop', e=> handleFiles(e.dataTransfer.files));

  function fitZoom(){
    if(passes.length===0) return 1;
    const p = passes[active];
    const vw = cv.clientWidth, vh = cv.clientHeight;
    const zx = vw / p.w, zy = vh / p.h;
    return Math.min(zx, zy);
  }
  function center(){
    if(passes.length===0) return;
    const p = passes[active];
    const vw = cv.clientWidth, vh = cv.clientHeight;
    panX = (vw - p.w*zoom)/2; panY = (vh - p.h*zoom)/2;
  }

  function drawBG(){
    if(bgToggle===0){
      ctx.fillStyle = '#0a0c10';
      ctx.fillRect(0,0,cv.clientWidth,cv.clientHeight);
      return;
    }
    // damero
    const s = 16; const w = cv.clientWidth, h = cv.clientHeight;
    for(let y=0;y<h;y+=s){
      for(let x=0;x<w;x+=s){
        ctx.fillStyle = ((x+y)/s)%2? '#0e1218':'#0b0f15';
        ctx.fillRect(x,y,s,s);
      }
    }
  }

  function draw(){
    ctx.setTransform(1,0,0,1,0,0);
    drawBG();
    if(passes.length===0) return;
    const p = passes[active];
    ctx.imageSmoothingEnabled = false;
    ctx.setTransform(1,0,0,1,panX,panY);
    ctx.scale(zoom, zoom);
    ctx.drawImage(p.img, 0, 0);
  }

  function updateInfo(){
    if(passes.length===0){ infoDim.textContent='–'; infoZoom.textContent='–'; return; }
    const p = passes[active];
    infoDim.textContent = `${p.w}×${p.h}`;
    infoZoom.textContent = `${Math.round(zoom*100)}%`;
  }

  // Interacción zoom/pan
  let dragging=false, lastX=0, lastY=0;
  cv.addEventListener('mousedown', e=>{ dragging=true; lastX=e.clientX; lastY=e.clientY; });
  window.addEventListener('mouseup', ()=> dragging=false);
  window.addEventListener('mousemove', e=>{
    if(!dragging) return; panX += (e.clientX-lastX); panY += (e.clientY-lastY); lastX=e.clientX; lastY=e.clientY; draw(); });

  cv.addEventListener('wheel', e=>{
    if(passes.length===0) return;
    e.preventDefault();
    const mx = e.offsetX, my = e.offsetY;
    const prevZoom = zoom;
    const delta = Math.sign(e.deltaY) * -0.1; // arriba zoom in
    zoom = Math.max(0.05, Math.min(32, zoom*(1+delta)));
    // zoom hacia cursor
    const p = passes[active];
    const wx = (mx - panX)/prevZoom; const wy = (my - panY)/prevZoom;
    panX = mx - wx*zoom; panY = my - wy*zoom;
    draw(); updateInfo();
  }, {passive:false});

  // Teclas: 1..9 para pases
  window.addEventListener('keydown', e=>{
    const n = parseInt(e.key,10);
    if(n>=1 && n<=9 && passes.length>0){
      const idx = Math.min(n-1, passes.length-1);
      setActive(idx); updateInfo();
    }
    if(e.key==='f'){ zoom = fitZoom(); center(); draw(); updateInfo(); }
    if(e.key==='0'){ zoom = 1; center(); draw(); updateInfo(); }
  });

  btnFit.addEventListener('click', ()=>{ zoom = fitZoom(); center(); draw(); updateInfo(); });
  btn100.addEventListener('click', ()=>{ zoom = 1; center(); draw(); updateInfo(); });
  btnBG.addEventListener('click', ()=>{ bgToggle = (bgToggle+1)%2; draw(); });

  // Resize observer para canvas responsivo
  const ro = new ResizeObserver(setCanvasSize); ro.observe(cv);
  setCanvasSize();
})();
</script>
</body>
</html>

